---
title: "Project 3: Structured State Space Models (S4) Applied to RL as a replacement of Transformers"
excerpt: "Implemented the innovative S4 model as a
replacement for a Transformer. Reduced by 86% the number of trainable parameters required"
collection: portfolio
category: ai
permalink: /portfolio/ai-project-3

---

<html>
<head>
  <title>Sequential Decision Modelling using Structured State Spaces</title>
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>
</head>
<body>

<h2>Sequential Decision Modelling using Structured State Spaces</h2>

<div style="text-align: center;">
    <img src="/files/s4dm.gif" alt="HalfCheetah" style="width: 500px;" />
    <img src="/files/s4dm1.gif" alt="Walker2d" style="width: 500px;" />
</div>

<h2>Overview</h2>

<p>This project explores the application of sequence models to the problem of credit assignment in Reinforcement Learning (RL). Specifically, it involves implementing a novel architecture, the Structured State Space Sequence Model (S4), within the framework of Decision Transformers. The aim is to improve the agent's ability to determine the true source of returns from a trajectory of states and actions, especially in environments with long episodes and sparse rewards.</p>

<h3>Key Objectives</h3>

<ol>
  <li><strong>S4 Implementation:</strong> Replace the transformer-based sequence model in the Decision Transformer framework with the S4 architecture to handle longer trajectories more effectively.</li>
  <li><strong>Performance Benchmarking:</strong> Compare the performance of the S4 Decision Model (S4DM) against the baseline Decision Transformer and Behavioral Cloning models across various RL environments.</li>
  <li><strong>Hyperparameter Tuning:</strong> Conduct a grid search to identify optimal hyperparameters for the S4 model to maximize performance.</li>
</ol>

<h3>Methodology</h3>

<ul>
  <li><strong>Data Collection:</strong> The project uses datasets from the OpenAI MuJoCo platform, including environments such as Half-Cheetah, Walker2D, and Hopper. These datasets contain trajectories generated by sub-optimal agents.</li>
  <li><strong>Sequence Modelling:</strong> The S4 architecture, which leverages the HiPPO kernel for efficient sequence modelling, is integrated into the Decision Transformer framework.</li>
  <li><strong>Experimental Setup:</strong> Experiments are conducted on three MuJoCo environments with datasets of "medium" and "medium-replay" trajectories. Each experiment is run multiple times with different seeds to ensure accuracy and reliability of results.</li>
</ul>

<h3>Structured State Space Sequence Model (S4)</h3>

<p>The S4 model is designed to address the problem of Long-Range Dependencies (LRDs) in sequential data, which are challenging for traditional models such as RNNs, CNNs, and Transformers due to issues like vanishing gradients.</p>

<p>The state space model is defined by the equations:</p>
<p>
\[ 
x'(t) = Ax(t) + Bu(t) 
\]
\[ 
y(t) = Cx(t) + Du(t) 
\]
</p>

<p>where \( x(t) \) is the state vector, \( u(t) \) is the input, and \( y(t) \) is the output. The matrices \( A \), \( B \), \( C \), and \( D \) define the dynamics of the state space model.</p>

<p>To address computational challenges, the S4 model modifies the state matrix \( A \) using the HiPPO kernel:</p>
<p>
\[ 
A = \text{HiPPO}(A) 
\]
</p>

<p>The HiPPO kernel provides a way to efficiently model long sequences by compressing historical data into a manageable representation.</p>

<h3>HiPPO Framework</h3>

<p>The HiPPO framework deals with the problem of memory in LRD as an online function approximation issue. It aims to maintain a compressed representation of the history of a function \( f \). The projection of \( f \) onto a polynomial space with respect to a measure \( \mu(t) \) results in coefficients \( c(t) \), which are updated recursively:</p>
<p>
\[ 
c'(t) = A c(t) + B u(t) 
\]
</p>

<p>By discretizing the dynamics, we can compute these coefficients efficiently, providing a compact form of the sequence's history.</p>

<h3>Implementation in Decision Transformer</h3>

<p>The Decision Transformer (DT) framework uses a transformer to predict future actions based on past states, actions, and a desired return-to-go. The S4DM model replaces the transformer with the S4 architecture. The trajectory is represented as:</p>
<p>
\[ 
\tau = [R_t, s_t, a_t, R_{t+1}, s_{t+1}, a_{t+1}, \ldots, R_T, s_T, a_T] 
\]
</p>

<h3>Training Procedure</h3>

<ol>
  <li><strong>Initialization:</strong> Initialize the state \( s \), action \( a \), and reward \( R \).</li>
  <li><strong>Sequence Modelling:</strong> Use the S4 layers to process the trajectory and predict the next action:
    \[
    a_{t+1} = \text{S4DM}([R_t, s_t, a_t, R_{t+1}, s_{t+1}, a_{t+1}, \ldots, R_T, s_T, a_T]) 
    \]
  </li>
  <li><strong>Optimization:</strong> Minimize the mean squared error between predicted and actual actions:
    \[
    \mathcal{L} = \frac{1}{T} \sum_{t=1}^T (a_t - \hat{a}_t)^2 
    \]
  </li>
</ol>

<h3>Hyperparameter Tuning</h3>

<p>A grid search was conducted to find the optimal hyperparameters, including the learning rate, kernel state space dimension, and number of S4 layers. The best performance was achieved with:</p>
<ul>
  <li>Learning rate: \( 6.1 \times 10^{-4} \)</li>
  <li>Kernel state space dimension: 256</li>
  <li>Number of S4 layers: 16</li>
</ul>

<h3>Results and Findings</h3>

<p>The S4DM model outperformed the baseline Decision Transformer and Behavioral Cloning models in terms of maximum reward obtained. The performance was sensitive to hyperparameter settings, with the best results achieved using the specified parameters.</p>

<h3>Conclusion</h3>

<p>The project demonstrates that the S4 architecture can effectively enhance the performance of Decision Transformers in RL tasks, particularly in environments with long trajectories. The increased "memory" provided by the HiPPO kernel enables better credit assignment, leading to improved performance.</p>

<h3>Repository and Resources</h3>

<p>To read the full analysis, you can download the <a href="https://vitoriarlima.github.io/files/S4_decision_transformer.pdf">PDF file</a>.</p>

<p>Slides deck presentation of the results <a href="https://docs.google.com/presentation/d/1zFm0WUj-mHd8MR1ytRNR7XZ_lBN9gw8SU58nzEDB0L8/edit?usp=sharing">here</a>.</p>

</body>
</html>



